/* STG HIGHFLYERS */
(function($) {
    var siteLangCode = jQuery('html')[0].lang;
    $(document).ready(function() {
        paramsChangeAfterLoad();
        addToCartEvent();
        initSlickSlider();
        wishListEvent();
        removeCookie();
        singleParamAutoClickProductPage();
    });

    function getUrlVars(url) {
        var vars = [];
        var hash;
        var hashes = url.slice(url.indexOf('?') + 1).split('&');
        for (var i = 0; i < hashes.length; i++) {
            hash = hashes[i].split('=');
            vars.push(hash[0]);
            vars[hash[0]] = hash[1];
        }
        return vars;
    }

    function addToCartEvent() {
        $('.ajax_add_to_cart').on('click', function(event) {
            event.preventDefault();
            event.stopPropagation();
            if ($(this).hasClass('disabled')) return false;
            var addToCartBtn = $(this);
            var params = getUrlVars($(this).attr('href'));
            paramsForCart = {};
            for (var i = 0; i < productsAttrs.length; i++) {
                if (productsAttrs[i].attribute_name == 'colors' || productsAttrs[i].attribute_name == 'sizes') {
                    paramsForCart["attribute_pa_" + productsAttrs[i].attribute_name] = decodeURI(params['pa_' + productsAttrs[i].attribute_name]);
                }
            }
            $.post(ajaxurl, {
                'action': 'woocommerce_add_variation_to_cart',
                "product_id": params['product_id'],
                "variation_id": params['variation_id'],
                "quantity": params['quantity'],
                "variation": paramsForCart,
				"cfwc-photo-field": params['cfwc-photo-field'],			
            }, function(response) {
                var data = {
                    'action': 'update_mini_cart'
                };
                $.post(ajaxurl, data, function(response) {
                    $('#mini-cart').html(response);
                    var data = {
                        'action': 'update_mini_cart_count'
                    };
                    $.post(ajaxurl, data, function(response) {
                        $('.cartSvg .count').html(response);
                        $('.cartSvg').toggleClass('newItem');
                        $('.newItemInCart').addClass('openned');
                        setTimeout(function() {
                            $('.cartSvg').toggleClass('newItem');
                        }, 1500);
                        $('<span class="p-added">מוצר התווסף לסל!</span>').insertAfter(addToCartBtn);
                        setTimeout(function() {
                            $('.p-added').remove();
                        }, 1500);
                        $('.cartSvg').addClass('newItemAdded');
                        setTimeout(function() {
                            $('.cartSvg').removeClass('newItemAdded');
                        }, 1000);
                        $('.cartSvg').trigger('click');
                        removeItemFromMiniCart();
                    });
                });
            }, 'json');
        })
    }

    function paramsChangeAfterLoad() {
        $('.params input').change(function(event) {
            var addToCartLink = $(this).parents('.upsale-item, .product-section').find('.ajax_add_to_cart');
            var paramsAreSet = 0;
            var radio_groups = {}
            $(this).parents('.params').find('input[type="radio"][name*="pa_"]').each(function() {
                radio_groups[this.name] = true;
            });
            var params = $(this).parents('.params').find('input[type="radio"][name*="pa_"]:checked');
            if ($(this).attr('name') == 'pa_colors') {
                $('.imageCarousel-nav[data-pid="' + $(this).attr('data-pid') + '"] img[data-color-id="' + $(this).attr('id') + '"]').trigger('click')
                $(this).parents('.param-section').find('.color-warp label').removeClass('active');
                $(this).parents('.param-section').find('label[for=' + $(this).attr('id') + ']').addClass('active');
                $(this).parents('.param-section').find('.current-color-title').html($(this).attr('data-val-name'));
                var newUrl = updateURLParameter(addToCartLink.attr('href'), $($(this)).data('param-name'), $(this).val());
            } else {
                $(this).parents('.param-section').find('.param-warp').removeClass('active');
                $(this).parents('.param-section').find('label[for=' + $(this).attr('id') + ']').parent('.param-warp').addClass('active');
                $(this).parents('.param-section').find('.current-param-title').html($(this).attr('data-val-name'));
                var newUrl = updateURLParameter(addToCartLink.attr('href'), $($(this)).data('param-name'), $(this).val());
            }
            addToCartLink.attr('href', newUrl);
            if (params.length == getPropertyCount(radio_groups)) {
                $(addToCartLink).removeClass('disabled');
            }
        });
        $('.desktop-quantity-buttons #minus, .mobile-quantity-buttons #minus').on('click', function(event) {
            var val = Number($('.quantity-buttons .quantity').val());
            if (val > 1) {
                $('.quantity').val(Number($('.quantity-buttons .quantity').val()) - 1);
                $('.quantity-buttons .quantity').trigger('change');
            }
        });
        $('.desktop-quantity-buttons #plus, .mobile-quantity-buttons #plus').on('click', function(event) {
            $('.quantity').val(Number($('.quantity-buttons .quantity').val()) + 1);
            $('.quantity-buttons .quantity').trigger('change');
        });
        $('.quantity').change(function(event) {
            var addToCartLink = $('.ajax_add_to_cart');
            var newUrl = updateURLParameter(addToCartLink.attr('href'), 'quantity', $(this).val());
            addToCartLink.attr('href', newUrl);
        });
    }

    function updateURLParameter(url, param, paramVal) {
        var newAdditionalURL = "";
        var tempArray = url.split("?");
        var baseURL = tempArray[0];
        var additionalURL = tempArray[1];
        var temp = "";
        if (additionalURL) {
            tempArray = additionalURL.split("&");
            for (var i = 0; i < tempArray.length; i++) {
                if (tempArray[i].split('=')[0] != param) {
                    newAdditionalURL += temp + tempArray[i];
                    temp = "&";
                }
            }
        }
        var rows_txt = temp + "" + param + "=" + paramVal;
        return baseURL + "?" + newAdditionalURL + rows_txt;
    }

    function getPropertyCount(obj) {
        var count = 0,
            key;
        for (key in obj) {
            if (obj.hasOwnProperty(key)) {
                count++;
            }
        }
        return count;
    }

    function wishListEvent() {
        $('.wishlist-link').on('click', function(event) {
            event.preventDefault();
            var wishlistHREF = $(this);
            var pid = $(this).data('pid');
            var toRemove = false;
            var toAdd = false;
            if ($(this).hasClass('inWishlist')) {
                data = {
                    'action': 'wishList',
                    'remove': pid,
                }
                toRemove = true;
            } else {
                data = {
                    'action': 'wishList',
                    'add': pid,
                }
                toAdd = true;
            }
            $.post(ajaxurl, data, function(response) {
                if (response.not_user) {
                    $.magnificPopup.open({
                        mainClass: 'mfp-fade',
                        items: {
                            src: '#wishlist_not_user'
                        },
                        type: 'inline',
                        midClick: true
                    });
                } else {
                    if (toAdd) {
                        $(wishlistHREF).addClass('inWishlist');
                    } else if (toRemove) {
                        $(wishlistHREF).removeClass('inWishlist');
                    }
                    $('body').append(response);
                }
            }, 'json');
        });
    }

    function removeCookie() {
        delete_cookie('wishlistFrom');
        delete_cookie('wishlistToAdd');
    }

    function delete_cookie(name) {
        document.cookie = name + '=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/';
    }

    function initSlickSlider() {
        $('.imageCarousel').slick({
            arrows: false,
            dots: true,
            infinite: false,
            slidesToShow: 1,
            slidesToScroll: 1,
            rtl: siteLangCode == 'he-IL' ? true : false,
            adaptiveHeight: false,
            autoplay: false,
            autoplaySpeed: 3000,
            draggable: true,
            mobileFirst: false,
            pauseOnHover: false,
            pauseOnDotsHover: false,
            swipe: false,
            fade: false,
            touchMove: true,
            touchThreshold: 5,
            responsive: [{
                breakpoint: 600,
                settings: {
                    swipe: true,
                }
            }]
        });

        function textsCarousel() {
            'use strict';
            $('#devTest').slick({
                arrows: false,
                dots: true,
                infinite: true,
                slidesToShow: 1,
                slidesToScroll: 1,
                rtl: false,
                adaptiveHeight: true,
                autoplay: true,
                autoplaySpeed: 3000,
                draggable: true,
                mobileFirst: true,
                pauseOnHover: false,
                pauseOnDotsHover: false,
                swipe: true,
                touchMove: true,
                touchThreshold: 5
            });
        }
        $('.imageCarousel-nav').slick({
            arrows: false,
            infinite: false,
            draggable: true,
            slidesToShow: 5,
            slidesToScroll: 1,
            asNavFor: '.imageCarousel',
            dots: false,
            centerMode: false,
            vertical: true,
            focusOnSelect: true
        });
        if ($(window).width() >= 1023) {
            $('.imageCarousel .slick-slide').zoom();
        } else {
            if ($('.imageCarousel .slick-dots li').length == 1) {
                $('.imageCarousel .slick-dots').addClass('dn');
            }
        }
    }

    function singleParamAutoClickProductPage() {
        let productParams = $('.product-section .params')
        let productParamSections = $('.param-section', productParams);
        let sectionHasMultiplyItems = false;
        productParamSections.each(function(j) {
            let sectionParamItems = $('input.item-param', $(this));
            sectionHasMultiplyItems = (sectionParamItems.length > 1) ? true : false;
            if ($(sectionParamItems).length > 0) {
                $('#' + $(sectionParamItems).attr('id')).trigger('click')
            }
        });
    }
})(jQuery);